<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Cortex Club</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>Cortex<span class="brand-accent">Club</span></h1>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="events.html">Events</a></li>
                <li><a href="news.html">News</a></li>
                <li><a href="committee.html">Committee</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <section class="section section-dark" style="margin-top: 70px;">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; flex-wrap: wrap; gap: 2rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="events-toggle-btn active" id="upcomingBtn">UPCOMING</button>
                    <button class="events-toggle-btn" id="pastBtn">PAST</button>
                </div>
                <input type="text" id="eventSearch" class="event-search-input" placeholder="SEARCH EVENTS...">
            </div>

            <div id="upcomingEvents" class="events-container">
                <h2 class="section-title">Upcoming Events</h2>
                <div class="events-grid" id="upcomingGrid"></div>
            </div>

            <div id="pastEvents" class="events-container" style="display: none;">
                <h2 class="section-title">Past Events</h2>
                <div id="pastGrid"></div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Cortex Club, University of Oxford. All rights reserved.</p>
        </div>
    </footer>

    <script src="../script.js"></script>
    <script>
        let allEvents = [];
        const currentDate = new Date();

        // Load all event JSON files dynamically
        async function loadEvents() {
            try {
                // First, load the index.json to get list of all event files
                const indexResponse = await fetch('../events/index.json');
                const indexData = await indexResponse.json();
                
                // Load all event files listed in index.json
                const promises = indexData.events.map(filename => 
                    fetch(`../events/${filename}`)
                        .then(response => response.json())
                        .catch(error => console.error(`Failed to load ${filename}:`, error))
                );

                const results = await Promise.all(promises);
                allEvents = results.filter(event => event !== undefined);
                console.log('Loaded events:', allEvents);
                sortAndDisplayEvents();
            } catch (error) {
                console.error('Failed to load events index:', error);
            }
        }

        function sortAndDisplayEvents() {
            const upcomingEvents = [];
            const pastEvents = [];

            // Get today's date without time for accurate comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allEvents.forEach(event => {
                const eventDate = new Date(event.date);
                eventDate.setHours(0, 0, 0, 0);
                
                if (eventDate >= today) {
                    upcomingEvents.push(event);
                } else {
                    pastEvents.push(event);
                }
            });

            // Sort upcoming events by date (ascending)
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            // Sort past events by date (descending)
            pastEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

            console.log('Total events loaded:', allEvents.length);
            console.log('Upcoming events:', upcomingEvents.length);
            console.log('Past events:', pastEvents.length);
            
            if (upcomingEvents.length === 0 && pastEvents.length === 0) {
                console.error('No events to display! Check dates.');
            }
            
            renderEvents(upcomingEvents, 'upcomingGrid', false);
            renderEventsByYear(pastEvents, 'pastGrid');
        }

        function renderEventsByYear(events, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (events.length === 0) return;

            // Group events by academic year (Sep 1 - Aug 31)
            const eventsByAcademicYear = {};
            
            events.forEach(event => {
                const eventDate = new Date(event.date);
                const year = eventDate.getFullYear();
                const month = eventDate.getMonth() + 1; // JS months are 0-indexed
                
                // Determine academic year: if Sep-Dec, it's in year-year+1; Jan-Aug it's in year-1-year
                let academicYearStart, academicYearEnd;
                if (month >= 9) {
                    // September to December: academic year starts this year
                    academicYearStart = year;
                    academicYearEnd = year + 1;
                } else {
                    // January to August: academic year started previous year
                    academicYearStart = year - 1;
                    academicYearEnd = year;
                }
                
                const academicYearKey = `${academicYearStart}-${academicYearEnd}`;
                
                if (!eventsByAcademicYear[academicYearKey]) {
                    eventsByAcademicYear[academicYearKey] = [];
                }
                eventsByAcademicYear[academicYearKey].push(event);
            });

            // Render each academic year section
            // Sort by the ending year (e.g., 2024-2025 comes before 2023-2024)
            Object.keys(eventsByAcademicYear).sort((a, b) => {
                const yearA = parseInt(a.split('-')[1]);
                const yearB = parseInt(b.split('-')[1]);
                return yearB - yearA;
            }).forEach(academicYear => {
                // Academic year heading (e.g., "2023-2024")
                const yearHeading = document.createElement('h3');
                yearHeading.textContent = academicYear;
                yearHeading.style.cssText = 'font-size: 2rem; color: var(--white); opacity: 0.9; letter-spacing: 3px; margin-top: 3rem; margin-bottom: 2rem; text-transform: uppercase; text-align: left; padding-left: 2rem;';
                container.appendChild(yearHeading);
                
                // Get events for this academic year
                const yearEvents = eventsByAcademicYear[academicYear];
                
                // Sort events within this academic year by date (newest first)
                yearEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Events grid for this year
                const yearGrid = document.createElement('div');
                yearGrid.className = 'events-grid';
                
                yearEvents.forEach(event => {
                    const eventCard = createEventCard(event);
                    yearGrid.appendChild(eventCard);
                });

                container.appendChild(yearGrid);
            });
        }

        function createEventCard(event) {
            const eventDate = new Date(event.date);
            const month = eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
            const day = eventDate.getDate();

            const eventCard = document.createElement('div');
            eventCard.className = 'event-card';
            eventCard.setAttribute('data-event', event.title.toLowerCase());

            eventCard.innerHTML = `
                <div class="event-date">
                    <span class="date-day">${day}</span>
                    <span class="date-month">${month}</span>
                </div>
                <h3>${event.title}</h3>
                <p>${event.description}</p>
                <a href="#" class="event-link">Learn More →</a>
            `;

            return eventCard;
        }

        function renderEvents(events, gridId, showYear = false) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            events.forEach(event => {
                const eventDate = new Date(event.date);
                const month = eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const day = eventDate.getDate();
                const year = eventDate.getFullYear();

                const eventCard = document.createElement('div');
                eventCard.className = 'event-card';
                eventCard.setAttribute('data-event', event.title.toLowerCase());

                const yearHtml = showYear ? `<span class="date-year">${year}</span>` : '';

                eventCard.innerHTML = `
                    <div class="event-date">
                        <span class="date-day">${day}</span>
                        <span class="date-month">${month}</span>
                        ${yearHtml}
                    </div>
                    <h3>${event.title}</h3>
                    <p>${event.description}</p>
                    <a href="#" class="event-link">Learn More →</a>
                `;

                grid.appendChild(eventCard);
            });
        }

        function showUpcoming() {
            document.getElementById('upcomingEvents').style.display = 'block';
            document.getElementById('pastEvents').style.display = 'none';
            document.querySelectorAll('.events-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('upcomingBtn').classList.add('active');
        }

        function showPast() {
            document.getElementById('upcomingEvents').style.display = 'none';
            document.getElementById('pastEvents').style.display = 'block';
            document.querySelectorAll('.events-toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('pastBtn').classList.add('active');
        }

        document.getElementById('upcomingBtn').addEventListener('click', showUpcoming);
        document.getElementById('pastBtn').addEventListener('click', showPast);

        document.getElementById('eventSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const activeContainer = document.getElementById('upcomingEvents').style.display === 'none' ? 'pastEvents' : 'upcomingEvents';
            const container = document.getElementById(activeContainer);
            
            // Get all grids in the active container (including nested ones)
            const grids = container.querySelectorAll('.events-grid');
            
            grids.forEach(grid => {
                Array.from(grid.children).forEach(card => {
                    const eventText = card.getAttribute('data-event');
                    if (eventText.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Initialize
        loadEvents();
    </script>

    <style>
        .events-toggle-btn {
            background: transparent;
            border: 2px solid var(--white);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .events-toggle-btn.active,
        .events-toggle-btn:hover {
            background: var(--white);
            color: var(--black);
        }

        .event-search-input {
            background: transparent;
            border: 2px solid var(--white);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            width: 300px;
            transition: var(--transition);
        }

        .event-search-input::placeholder {
            color: var(--white);
            opacity: 0.5;
        }

        .event-search-input:focus {
            outline: none;
            border-color: var(--grey);
        }

        .event-card {
            border: 2px solid var(--white);
            opacity: 0.6;
            transition: var(--transition);
        }

        .event-card:hover {
            opacity: 1;
            border-color: var(--white);
        }

        @media (max-width: 768px) {
            .event-search-input {
                width: 100%;
            }
        }
    </style>
</body>
</html>
